<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>magneto setting</title>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; background: #f4f6f9; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        h1 { margin-top: 0; border-bottom: 1px solid #eee; padding-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .nav-link { font-size: 14px; text-decoration: none; color: #007bff; }
        
        /* å¸ƒå±€ç½‘æ ¼ */
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media(max-width: 900px) { .grid { grid-template-columns: 1fr; } }

        /* å¡ç‰‡æ ·å¼ */
        .card { border: 1px solid #e0e0e0; border-radius: 6px; padding: 20px; background: #fff; margin-bottom: 20px; }
        .card h3 { margin-top: 0; color: #333; border-bottom: 1px dashed #eee; padding-bottom: 10px; margin-bottom: 15px; }
        
        /* è¡¨å•å…ƒç´  */
        .form-group { margin-bottom: 15px; }
        label { display: block; margin-bottom: 5px; font-weight: bold; color: #555; font-size: 0.9em; }
        select, input[type="text"], textarea { width: 100%; padding: 8px 10px; border: 1px solid #ced4da; border-radius: 4px; box-sizing: border-box; font-size: 14px; }
        select:focus, input:focus, textarea:focus { border-color: #80bdff; outline: 0; box-shadow: 0 0 0 0.2rem rgba(0,123,255,.25); }
        textarea { font-family: monospace; height: 350px; resize: vertical; background: #fafafa; }
        
        /* æŒ‰é’®ç»„ */
        .btn { padding: 8px 16px; border: none; border-radius: 4px; cursor: pointer; font-size: 14px; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 5px; }
        .btn-primary { background: #007bff; color: white; }
        .btn-primary:hover { background: #0056b3; }
        .btn-success { background: #28a745; color: white; }
        .btn-success:hover { background: #218838; }
        .btn-secondary { background: #6c757d; color: white; }
        .btn-outline { background: transparent; border: 1px solid #6c757d; color: #6c757d; }
        .btn-outline:hover { background: #f8f9fa; }
        
        /* æ¶ˆæ¯æç¤º */
        .flash { padding: 12px; margin-bottom: 20px; border-radius: 4px; }
        .flash.success { background: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .flash.error { background: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }
        
        /* åŠ¨æ€åŒºåŸŸ */
        .task-params { display: none; background: #f8f9fa; padding: 15px; border-radius: 4px; border: 1px solid #e9ecef; }
        .task-params.active { display: block; }
        .d-none { display: none !important; }

        /* Cron åŒºåŸŸé«˜äº® */
        .cron-section { background: #e8f5e9; padding: 15px; border-radius: 4px; border: 1px solid #c8e6c9; margin-top: 15px; }
    </style>
</head>
<body>

<div class="container">
    <h1>
        <span>âš™ï¸ magneto setting</span>
        <a href="/" class="nav-link">â† back magneto</a>
    </h1>

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        {% for category, message in messages %}
          <div class="flash {{ category }}">{{ message }}</div>
        {% endfor %}
      {% endif %}
    {% endwith %}

    <div class="grid">
        
        <div class="card">
            <h3>ğŸ› ï¸ ä»»åŠ¡æ§åˆ¶ä¸­å¿ƒ</h3>
            
            <form method="POST" id="taskForm">
                
                <div class="form-group" style="display: flex; gap: 10px;">
                    <div style="flex: 1;">
                        <label>ä»»åŠ¡ç±»å‹</label>
                        <select name="task_type" id="taskTypeSelector">
                            <option value="javbee">Javbee (çˆ¬è™«+å…¥åº“)</option>
                            <option value="sehuatang">Sehuatang (åˆ—è¡¨+è¯¦æƒ…)</option>
                            <option value="nyaa">Nyaa (åˆ—è¡¨çˆ¬è™«)</option>
                            <option value="retag">æ ‡ç­¾é‡æ•´ (Retag)</option>
                        </select>
                    </div>
                    <div style="flex: 1;">
                        <label>é…ç½®æ–‡ä»¶ (Site)</label>
                        <select name="param1" id="siteSelector">
                            {% if config_files %}
                                {% for f in config_files %}
                                <option value="{{ f.replace('.yaml', '') }}">{{ f }}</option>
                                {% endfor %}
                            {% else %}
                                <option value="">(æ— é…ç½®)</option>
                            {% endif %}
                        </select>
                    </div>
                </div>

                <div id="params-javbee" class="task-params active">
                    <div class="form-group">
                        <label>æ–¹å¼ A: æŒ‰æ—¥æœŸ (ç•™ç©ºåˆ™é»˜è®¤ä¸ºæ˜¨å¤©)</label>
                        <input type="text" name="param_jav_date" placeholder="YYYY-MM-DD">
                    </div>
                    <div style="text-align: center; color: #999; margin: 5px 0;">--- æˆ– ---</div>
                    <div class="form-group">
                        <label>æ–¹å¼ B: æŒ‰æ ‡ç­¾/å…³é”®è¯</label>
                        <div style="display: flex; gap: 10px;">
                            <input type="text" name="param_jav_tag" placeholder="ä¾‹å¦‚: older-sister" style="flex: 3;">
                            <input type="number" name="param_jav_start" value="1" placeholder="èµ·å§‹é¡µ" style="flex: 1;" min="1">
                        </div>
                        <small style="color: #666;">æ³¨æ„ï¼šå¦‚æœå¡«å†™äº†æ ‡ç­¾ï¼Œå°†å¿½ç•¥æ—¥æœŸå‚æ•°ã€‚</small>
                    </div>
                </div>

                <div id="params-sehuatang" class="task-params">
                    <div class="form-group">
                        <label>é¢å¤–å‚æ•° (å¯é€‰):</label>
                        <input type="text" name="param_sech_page" placeholder="ä¾‹å¦‚: 1-5 æˆ– --retry-failed">
                        <small style="color: #666;">æ”¯æŒé¡µç èŒƒå›´ã€--retry-failed ç­‰ã€‚ç•™ç©ºåˆ™æ‰§è¡Œæ ‡å‡†å¢é‡æ›´æ–°ã€‚</small>
                    </div>
                </div>

                <div id="params-nyaa" class="task-params">
                    <div class="form-group" style="display: flex; gap: 10px;">
                        <div style="flex: 1;">
                            <label>èµ·å§‹é¡µ:</label>
                            <input type="text" name="param_nyaa_start" value="1">
                        </div>
                        <div style="flex: 1;">
                            <label>ç»“æŸé¡µ:</label>
                            <input type="text" name="param_nyaa_end" value="auto">
                        </div>
                    </div>
                </div>

                <div id="params-retag" class="task-params">
                    <p style="margin: 0; color: #666;">æ— éœ€é¢å¤–å‚æ•°ï¼Œä»…æ ¹æ®é…ç½®æ–‡ä»¶é‡æ•´æ ‡ç­¾ã€‚</p>
                </div>

                <div id="cronSection" class="cron-section d-none">
                    <div class="form-group">
                        <label>â±ï¸ æ‰§è¡Œé¢‘ç‡ (Cron è¡¨è¾¾å¼):</label>
                        <div style="display: flex; gap: 10px; margin-bottom: 5px;">
                            <select style="width: 150px;" onchange="document.getElementById('cronInput').value = this.value">
                                <option value="">-- æ¨¡æ¿ --</option>
                                <option value="0 2 * * *">æ¯å¤© 02:00</option>
                                <option value="0 12 * * *">æ¯å¤© 12:00</option>
                                <option value="*/30 * * * *">æ¯ 30 åˆ†é’Ÿ</option>
                            </select>
                            <input type="text" name="cron_expression" id="cronInput" placeholder="åˆ† æ—¶ æ—¥ æœˆ å‘¨ (å¦‚: 30 2 * * *)">
                        </div>
                        <small style="color: #2e7d32;">å¡«å†™æ­¤é¡¹å°†æŠŠå½“å‰é…ç½®æ·»åŠ ä¸ºå®šæ—¶ä»»åŠ¡ã€‚</small>
                    </div>
                </div>

                <div style="margin-top: 25px; display: flex; gap: 10px; align-items: center;">
                    <button type="submit" formaction="/run_advanced_task" class="btn btn-primary" style="flex: 1;">
                        ğŸš€ ç«‹å³æ‰§è¡Œ
                    </button>
                    
                    <button type="button" id="toggleCronBtn" class="btn btn-outline" onclick="toggleCronMode()">
                        â° è®¾ä¸ºå®šæ—¶ä»»åŠ¡
                    </button>

                    <button type="submit" formaction="/api/add_job" id="submitCronBtn" class="btn btn-success d-none" style="flex: 1;">
                        â• ç¡®è®¤æ·»åŠ è®¡åˆ’
                    </button>
                </div>
            </form>

            <hr style="margin: 20px 0; border: 0; border-top: 1px solid #eee;">
            
            <div style="text-align: center;">
                <a href="/logs" target="_blank" class="nav-link">ğŸ“„ æ‰“å¼€è¿è¡Œæ—¥å¿—çª—å£</a>
            </div>
        </div>

        <div class="card">
            <h3>ğŸ“ é…ç½®æ–‡ä»¶ç®¡ç†</h3>
            
            <div class="form-group" style="display: flex; gap: 5px; align-items: flex-end;">
                <div style="flex-grow: 1;" id="selectFileContainer">
                    <label>é€‰æ‹©æ–‡ä»¶:</label>
                    <select id="configFileSelector">
                        <option value="">-- è¯·é€‰æ‹© --</option>
                        {% for f in config_files %}
                            <option value="{{ f }}">{{ f }}</option>
                        {% endfor %}
                    </select>
                </div>
                
                <div style="flex-grow: 1;" id="newFileContainer" class="d-none">
                    <label style="color: #28a745;">æ–°æ–‡ä»¶å (.yaml):</label>
                    <input type="text" id="newFilename" placeholder="my_site.yaml">
                </div>

                <button type="button" class="btn btn-secondary" id="toggleModeBtn" onclick="toggleEditMode()" style="height: 38px;">â• æ–°å»º</button>
            </div>

            <div class="form-group">
                <textarea id="configContent" placeholder="åœ¨æ­¤ç¼–è¾‘é…ç½®å†…å®¹..."></textarea>
            </div>
            <div style="text-align: right;">
                <button type="button" class="btn btn-success" onclick="saveConfig()">ğŸ’¾ ä¿å­˜é…ç½®</button>
            </div>
        </div>

        <div class="card" style="grid-column: 1 / -1;">
            <h3>ğŸ“… å·²è®¡åˆ’çš„å®šæ—¶ä»»åŠ¡</h3>
            <table style="width: 100%; border-collapse: collapse; margin-top: 10px;">
                <thead>
                    <tr style="background: #f8f9fa; text-align: left; border-bottom: 2px solid #eee;">
                        <th style="padding: 12px; color: #555;">ä»»åŠ¡è¯¦æƒ…</th>
                        <th style="padding: 12px; color: #555;">æ‰§è¡Œç­–ç•¥ (Cron)</th>
                        <th style="padding: 12px; color: #555;">ä¸‹æ¬¡è¿è¡Œæ—¶é—´</th>
                        <th style="padding: 12px; color: #555; text-align: right;">æ“ä½œ</th>
                    </tr>
                </thead>
                <tbody id="jobsTableBody">
                    <tr><td colspan="4" style="padding: 20px; text-align:center; color:#999;">æ­£åœ¨åŠ è½½ä»»åŠ¡åˆ—è¡¨...</td></tr>
                </tbody>
            </table>
        </div>

    </div>
</div>

<script>
    // --- 1. ä»»åŠ¡å‚æ•°è”åŠ¨é€»è¾‘ ---
    const taskSelector = document.getElementById('taskTypeSelector');
    const paramDivs = document.querySelectorAll('.task-params');
    const inputs = document.querySelectorAll('.task-params input');

    taskSelector.addEventListener('change', function() {
        // éšè—æ‰€æœ‰ç‰¹å®šå‚æ•°åŒºï¼Œç¦ç”¨ input é¿å…æäº¤è„æ•°æ®
        paramDivs.forEach(div => div.classList.remove('active'));
        inputs.forEach(input => input.disabled = true);

        // æ˜¾ç¤ºå½“å‰é€‰ä¸­ä»»åŠ¡çš„å‚æ•°åŒº
        const selectedId = 'params-' + this.value;
        const activeDiv = document.getElementById(selectedId);
        if(activeDiv) {
            activeDiv.classList.add('active');
            activeDiv.querySelectorAll('input').forEach(i => i.disabled = false);
        }
    });
    // åˆå§‹åŒ–
    taskSelector.dispatchEvent(new Event('change'));

    // --- 2. Cron æ¨¡å¼åˆ‡æ¢é€»è¾‘ ---
    const cronSection = document.getElementById('cronSection');
    const toggleCronBtn = document.getElementById('toggleCronBtn');
    const submitCronBtn = document.getElementById('submitCronBtn');
    const cronInput = document.getElementById('cronInput');
    let isCronMode = false;

    function toggleCronMode() {
        isCronMode = !isCronMode;
        if(isCronMode) {
            cronSection.classList.remove('d-none');
            toggleCronBtn.classList.add('d-none'); // éšè—è‡ªå·±
            submitCronBtn.classList.remove('d-none'); // æ˜¾ç¤ºæäº¤æŒ‰é’®
            cronInput.required = true; // å¿…å¡«
        } else {
            cronSection.classList.add('d-none');
            toggleCronBtn.classList.remove('d-none');
            submitCronBtn.classList.add('d-none');
            cronInput.required = false;
        }
    }

    // --- 3. å®šæ—¶ä»»åŠ¡åˆ—è¡¨åŠ è½½ ---
    function loadJobs() {
        fetch('/api/jobs')
            .then(res => res.json())
            .then(data => {
                const tbody = document.getElementById('jobsTableBody');
                tbody.innerHTML = '';
                if(data.jobs.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" style="text-align:center; padding: 20px; color:#999;">æš‚æ— å®šæ—¶ä»»åŠ¡ï¼Œè¯·åœ¨ä¸Šæ–¹æ·»åŠ ã€‚</td></tr>';
                    return;
                }
                data.jobs.forEach(job => {
                    const row = `
                        <tr style="border-bottom: 1px solid #eee;">
                            <td style="padding: 12px;"><strong>${job.name}</strong></td>
                            <td style="padding: 12px;"><span style="background:#e8f5e9; color:#2e7d32; padding:2px 6px; border-radius:4px; font-family:monospace;">${job.trigger}</span></td>
                            <td style="padding: 12px; color: #666;">${job.next_run}</td>
                            <td style="padding: 12px; text-align: right;">
                                <a href="/api/delete_job/${job.id}" class="btn btn-outline" style="padding: 4px 10px; font-size: 12px; color: #dc3545; border-color: #dc3545;">åˆ é™¤</a>
                            </td>
                        </tr>
                    `;
                    tbody.innerHTML += row;
                });
            });
    }
    document.addEventListener('DOMContentLoaded', loadJobs);

    // --- 4. é…ç½®æ–‡ä»¶ç¼–è¾‘é€»è¾‘ ---
    const fileSelector = document.getElementById('configFileSelector');
    const newFileContainer = document.getElementById('newFileContainer');
    const selectFileContainer = document.getElementById('selectFileContainer');
    const toggleModeBtn = document.getElementById('toggleModeBtn');
    const newFilenameInput = document.getElementById('newFilename');
    const textArea = document.getElementById('configContent');
    let isNewFileMode = false;

    function toggleEditMode() {
        isNewFileMode = !isNewFileMode;
        if (isNewFileMode) {
            selectFileContainer.classList.add('d-none');
            newFileContainer.classList.remove('d-none');
            toggleModeBtn.innerText = "ğŸ”™ è¿”å›";
            toggleModeBtn.classList.replace('btn-secondary', 'btn-outline');
            fileSelector.value = "";
            textArea.value = `# æ–°å»ºé…ç½®æ–‡ä»¶æ¨¡æ¿\nsite_name: "example"\nbase_url: "https://example.com"\ndatabase_file: "example.db"\nlog_level: "INFO"\nrequest_delay: 1\nstop_on_consecutive_duplicates: 10\ntag_rules:\n  "é«˜æ¸…": ["FHD", "1080p"]`;
        } else {
            selectFileContainer.classList.remove('d-none');
            newFileContainer.classList.add('d-none');
            toggleModeBtn.innerText = "â• æ–°å»º";
            toggleModeBtn.classList.replace('btn-outline', 'btn-secondary');
            textArea.value = "";
        }
    }

    fileSelector.addEventListener('change', function() {
        const filename = this.value;
        if(!filename) { textArea.value = ""; return; }
        fetch('/api/get_config?filename=' + filename)
            .then(res => res.text())
            .then(data => textArea.value = data)
            .catch(err => alert('åŠ è½½å¤±è´¥: ' + err));
    });

    function saveConfig() {
        let filename;
        const content = textArea.value;
        if (isNewFileMode) {
            filename = newFilenameInput.value.trim();
            if (!filename) { alert("è¯·è¾“å…¥æ–‡ä»¶åï¼"); return; }
            if (!filename.endsWith('.yaml')) { alert("å¿…é¡»ä»¥ .yaml ç»“å°¾ï¼"); return; }
        } else {
            filename = fileSelector.value;
            if (!filename) { alert("è¯·å…ˆé€‰æ‹©æ–‡ä»¶ï¼"); return; }
        }

        const formData = new FormData();
        formData.append('filename', filename);
        formData.append('content', content);

        fetch('/api/save_config', { method: 'POST', body: formData })
        .then(res => {
            if(res.ok) {
                alert('âœ… ä¿å­˜æˆåŠŸï¼');
                if (isNewFileMode) location.reload();
            } else res.text().then(text => alert('âŒ å¤±è´¥: ' + text));
        })
        .catch(err => alert('é”™è¯¯: ' + err));
    }
</script>

</body>
</html>